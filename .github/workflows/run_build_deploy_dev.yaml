
name: Build and Deploy to Dev
on:
  push:
    branches:
      - develop
  workflow_dispatch: {}


concurrency:
  cancel-in-progress: false
  group: api-build-deploy-dev

permissions:
  id-token: write
  contents: read
  issues: write


jobs:
  build:
    name: Docker Build and Push
    secrets: inherit
    uses: ./.github/workflows/_build.yaml

  migrations:
    needs: build
    name: Run Migrations in Dev
    secrets:
      slack-webhook: ${{ secrets.SLACK_WEBHOOK_DEPLOY_TO_DEV }}
    uses: ./.github/workflows/_migrations.yaml
    with:
      env-name: dev
      image-tag: latest

  deploy:
    name: Deploy to Dev
    needs: [ build, migrations ]
    secrets:
      slack-webhook: ${{ secrets.SLACK_WEBHOOK_DEPLOY_TO_DEV }}
    uses: ./.github/workflows/_deploy.yaml
    with:
      image-tag: latest
      env-name: dev

  run-e2e-tests:
    name: Run E2E Test Suite
    needs: [ deploy ]
    if: ${{ !cancelled() && needs.deploy-dev.result == 'success' }}
    uses: ChildMindInstitute/mindlogger-backend-refactor/.github/workflows/e2e-tests.yaml@develop
    secrets: inherit
    permissions:
      contents: write
      id-token: write
    with:
      service-url: https://api-dev.cmiml.net

  comment-e2e-tests:
    name: Comment on test outcome
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      statuses: write
    needs: [run-e2e-tests]
    steps:
      - name: "Send Slack message on failure"
        if: ${{ needs.run-e2e-tests.result != 'success' }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_COLOR: failure
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_TEST_RESULTS }}
          SLACKIFY_MARKDOWN: true
          SLACK_TITLE: |
            :rotating_light: E2E test suite failed
          SLACK_MESSAGE: >-
            E2E tests for dev failed in ${{ github.repository }}
            \n\n
            :arrow_right: [Action Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            \n\n
            :label: [Commit](${{ github.event.head_commit.url }}) | :chart_with_upwards_trend: [Test Report](${{ needs.run-e2e-tests.outputs.report-url }})
          SLACK_ICON: https://github.com/github.png?size=48
          MSG_MINIMAL: true


      - name: Post the link to the report
        if: ${{ !cancelled() }}
        uses: guibranco/github-status-action-v2@v1
        with:
          authToken: ${{secrets.GITHUB_TOKEN}}
          context: 'E2E Test report'
          state: ${{ needs.run-e2e-tests.result }}
          sha: ${{ github.head_ref }}
          target_url: ${{ needs.run-e2e-tests.outputs.report-url }}



name: Update Jira Tickets

on:
  release:
    types: [created]
  # Allows running manually from the Actions tab
  workflow_dispatch:
    inputs:
      tagName:
        description: 'Tag Name'
        required: true

jobs:
  process-release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Get current tag
        id: get-tag
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            currentTag=${GITHUB_REF#refs/tags/}
          elif [ "${{ github.event_name }}" == "push" ]; then
            currentTag=v1.3.21-rc1
          else
            currentTag=${{ github.event.inputs.tagName }}
          fi
          echo "Tag: ${currentTag}"
          echo "::set-output name=tag::${currentTag}"

      - name: Check if tag is a release candidate
        run: |
          if [[ ${{ steps.get-tag.outputs.tag }} != *"-rc"* ]]; then
            echo "Not a release candidate, ending workflow."
            exit 0
          fi

      - name: Ping Jenkins for previous successful tag
        id: ping-jenkins
        run: |
          repoName=${GITHUB_REPOSITORY##*/}
          currentTag=${{ steps.get-tag.outputs.tag }}
          git fetch --tags
          rcTags=$(git tag --sort=-creatordate | grep rc)
          started=false
          for tagName in $rcTags
          do
            # Skip tags more recent than the current one
            if [ "$tagName" != "$currentTag" ] && [ "$started" = false ]; then
              continue;
            elif [ "$tagName" == "$currentTag" ]; then
              started=true;
              continue;
            fi

            echo "Checking for successful Jenkins build for GitHub tag ${tagName}"
            response=$(curl -o /dev/null --silent -w "%{http_code}\n" -u "${{ secrets.JENKINS_USER }}:${{ secrets.JENKINS_TOKEN }}" "${{ env.JENKINS_HOST }}/job/${repoName}/view/tags/job/${tagName}/lastSuccessfulBuild/api/json")
            if [ "$response" == "200" ]; then
              echo "Found successful Jenkins build for GitHub tag ${tagName}: ${{ env.JENKINS_HOST }}/job/${repoName}/view/tags/job/${tagName}/lastSuccessfulBuild"
              echo "::set-output name=tagName::$tagName"
              break
            fi
          done

      - name: Get commit messages between tags
        id: get-commits
        run: |
          currentTag=${{ steps.get-tag.outputs.tag }}
          previousTag=${{ steps.ping-jenkins.outputs.tagName }}
          if [ "$previousTag" == "" ]; then
            commitMessages=$(git log --pretty=%B $currentTag)
          else
            commitMessages=$(git log --pretty=%B $previousTag..$currentTag)
          fi
          echo "Commit messages since the last release: ${commitMessages}"
          echo "::set-output name=messages::$commitMessages"

      - name: Determine Jira tickets from commit messages
        id: jira-tickets
        run: |
          commitMessages=${{ steps.get-commits.outputs.messages }}
          jiraTickets=$(echo "$commitMessages" | grep -io 'M2-[0-9]\+' | tr '[:lower:]' '[:upper:]' | sort | uniq | tr '\n' ' ')
          echo "Jira tickets since the last release: ${jiraTickets}"
          echo "::set-output name=tickets::$jiraTickets"

      - name: Periodically ping Jenkins for current tag build status
        run: |
          repoName=${GITHUB_REPOSITORY##*/}
          currentTag=${{ steps.get-tag.outputs.tag }}
          "Waiting for current build to finish.."
          while true; do
            echo -n "."
            result=$(curl --silent -u "${{ secrets.JENKINS_USER }}:${{ secrets.JENKINS_TOKEN }}" "${{ env.JENKINS_HOST }}/job/${repoName}/view/tags/job/${currentTag}/lastBuild/api/json" | jq -r .result)
            if [[ "$result" == "SUCCESS" ]]; then
              echo "Build successful! Submitting ticket numbers to Jira"
              tickets=${{ steps.jira-tickets.outputs.tickets }}
              json="{ \"issues\": $(echo "${tickets}" | jq -R -s -c 'split(" ")[:-1]') }"
              curl -X POST -H 'Content-Type: application/json' --url "${{ secrets.JIRA_WEBHOOK_URL }}" --data "$json"
              break
            elif [[ "$result" != "null" ]]; then
              # TODO: Determine what the possible states of `result` are
              echo "Build failed, ending workflow"
              break
            fi
            sleep 60
          done
